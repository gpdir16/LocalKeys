<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LocalKeys</title>
        <link rel="stylesheet" href="../styles/common.css" />
    </head>
    <body>
        <div class="container">
            <div class="page-header dashboard-header">
                <h1 class="page-title" id="page-title">Projects</h1>
                <div class="header-actions">
                    <button class="btn" id="add-project-btn">Add Project</button>
                    <button class="btn btn-secondary" id="logs-btn">Logs</button>
                    <button class="btn btn-secondary" id="lock-btn">Lock</button>
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" id="settings-dropdown-btn">‚ãØ</button>
                        <div class="dropdown-menu hidden" id="dropdown-settings">
                            <button class="dropdown-item" id="install-cli-btn">Install CLI</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Í≤ÄÏÉâ Î∞î -->
            <div class="search-bar">
                <input type="text" class="search-input" id="search-input" placeholder="Search projects..." />
                <span class="search-icon">üîç</span>
            </div>

            <!-- ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù -->
            <div id="projects-container">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- ÌîÑÎ°úÏ†ùÌä∏ Ï∂îÍ∞Ä Î™®Îã¨ -->
        <div id="add-project-modal" class="modal-overlay hidden">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="modal-title">Add New Project</h3>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <label for="project-name" id="label-project-name">Project Name</label>
                        <input type="text" id="project-name" placeholder="Enter project name" autocomplete="off" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-add-project">Cancel</button>
                    <button class="btn" id="confirm-add-project">Add Project</button>
                </div>
            </div>
        </div>

        <script src="../modules/i18n-helper.js"></script>
        <script src="../modules/notification.js"></script>

        <script>
            document.addEventListener("DOMContentLoaded", async function () {
                // Îã§Íµ≠Ïñ¥ Ï¥àÍ∏∞Ìôî
                await i18n.init();

                // UI Î≤àÏó≠ Ï†ÅÏö©
                document.getElementById("page-title").textContent = i18n.t("dashboard.title");
                document.getElementById("add-project-btn").textContent = i18n.t("dashboard.addProject");
                document.getElementById("logs-btn").textContent = i18n.t("dashboard.logs");
                document.getElementById("lock-btn").textContent = i18n.t("dashboard.lock");
                document.getElementById("install-cli-btn").textContent = i18n.t("dashboard.installCli");
                document.getElementById("search-input").placeholder = i18n.t("dashboard.searchPlaceholder");
                document.getElementById("modal-title").textContent = i18n.t("dashboard.addProjectModal.title");
                document.getElementById("label-project-name").textContent = i18n.t("dashboard.addProjectModal.label");
                document.getElementById("project-name").placeholder = i18n.t("dashboard.addProjectModal.placeholder");
                document.getElementById("cancel-add-project").textContent = i18n.t("common.cancel");
                document.getElementById("confirm-add-project").textContent = i18n.t("dashboard.addProjectModal.add");

                const projectsContainer = document.getElementById("projects-container");

                const searchInput = document.getElementById("search-input");

                const addProjectBtn = document.getElementById("add-project-btn");

                const logsBtn = document.getElementById("logs-btn");

                const lockBtn = document.getElementById("lock-btn");

                const installCliBtn = document.getElementById("install-cli-btn");

                const addProjectModal = document.getElementById("add-project-modal");

                const projectNameInput = document.getElementById("project-name");

                const cancelAddProject = document.getElementById("cancel-add-project");

                const confirmAddProject = document.getElementById("confirm-add-project");

                const settingsDropdownBtn = document.getElementById("settings-dropdown-btn");

                let projects = [];

                let filteredProjects = [];

                // ÌîÑÎ°úÏ†ùÌä∏ Î°úÎìú

                async function loadProjects() {
                    try {
                        const result = await window.localkeys.projects.get();

                        if (result.success) {
                            projects = result.data;

                            filteredProjects = projects;

                            renderProjects();
                        } else {
                            notificationManager.error("Failed to load projects");
                        }
                    } catch (error) {
                        notificationManager.error(`Error loading projects: ${error.message}`);
                    }
                }

                function createProjectCard(project) {
                    const card = document.createElement("div");

                    card.className = "project-card";

                    card.onclick = () => openProject(project.name);

                    const nameDiv = document.createElement("div");

                    nameDiv.className = "project-name";

                    nameDiv.textContent = project.name;

                    const dateDiv = document.createElement("div");

                    dateDiv.className = "project-date";

                    dateDiv.textContent = `Updated ${formatDate(project.updatedAt)}`;

                    const statsDiv = document.createElement("div");

                    statsDiv.className = "project-stats";

                    const secretCountDiv = document.createElement("div");

                    secretCountDiv.className = "secret-count";

                    secretCountDiv.textContent = `${project.secretCount} secrets`;

                    const actionsDiv = document.createElement("div");

                    actionsDiv.className = "project-actions";

                    const dropdownDiv = document.createElement("div");

                    dropdownDiv.className = "dropdown";

                    const dropdownBtn = document.createElement("button");

                    dropdownBtn.className = "btn btn-secondary dropdown-toggle";

                    dropdownBtn.textContent = "‚ãØ";

                    dropdownBtn.onclick = (e) => {
                        e.stopPropagation();

                        toggleDropdown(project.name);
                    };

                    const dropdownMenu = document.createElement("div");

                    dropdownMenu.className = "dropdown-menu hidden";

                    dropdownMenu.id = `dropdown-${project.name}`;

                    const deleteBtn = document.createElement("button");

                    deleteBtn.className = "dropdown-item";

                    deleteBtn.textContent = "Delete Project";

                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();

                        deleteProject(project.name);
                    };

                    dropdownMenu.appendChild(deleteBtn);

                    dropdownDiv.appendChild(dropdownBtn);

                    dropdownDiv.appendChild(dropdownMenu);

                    actionsDiv.appendChild(dropdownDiv);

                    statsDiv.appendChild(secretCountDiv);

                    statsDiv.appendChild(actionsDiv);

                    card.appendChild(nameDiv);

                    card.appendChild(dateDiv);

                    card.appendChild(statsDiv);

                    return card;
                }

                function createEmptyStateElement() {
                    const emptyState = document.createElement("div");

                    emptyState.className = "empty-state";

                    const icon = document.createElement("div");

                    icon.className = "empty-state-icon";

                    icon.textContent = "üìÅ";

                    const title = document.createElement("div");

                    title.className = "empty-state-title";

                    title.textContent = "No projects found";

                    const description = document.createElement("div");

                    description.className = "empty-state-description";

                    description.textContent = projects.length === 0 ? "Create your first project to start managing your secrets securely." : "No projects match your search criteria.";

                    emptyState.appendChild(icon);

                    emptyState.appendChild(title);

                    emptyState.appendChild(description);

                    if (projects.length === 0) {
                        const createBtn = document.createElement("button");

                        createBtn.className = "btn";

                        createBtn.textContent = "Create Project";

                        createBtn.onclick = showAddProjectModal;

                        emptyState.appendChild(createBtn);
                    }

                    return emptyState;
                }

                // ÌîÑÎ°úÏ†ùÌä∏ Î†åÎçîÎßÅ

                function renderProjects() {
                    projectsContainer.innerHTML = ""; // Clear existing content

                    if (filteredProjects.length === 0) {
                        projectsContainer.appendChild(createEmptyStateElement());

                        return;
                    }

                    const grid = document.createElement("div");

                    grid.className = "projects-grid";

                    filteredProjects.forEach((project) => {
                        grid.appendChild(createProjectCard(project));
                    });

                    projectsContainer.appendChild(grid);
                }

                // ÌîÑÎ°úÏ†ùÌä∏ Ïó¥Í∏∞

                function openProject(projectName) {
                    window.location.href = `project.html?name=${encodeURIComponent(projectName)}`;
                }

                // ÌîÑÎ°úÏ†ùÌä∏ ÏÇ≠Ï†ú

                async function deleteProject(projectName) {
                    if (!confirm(`Are you sure you want to delete project "${projectName}"? This will also delete all secrets in this project.`)) {
                        return;
                    }

                    try {
                        const result = await window.localkeys.projects.delete(projectName);

                        if (result.success) {
                            await loadProjects();

                            notificationManager.success(`Project "${projectName}" deleted successfully`);
                        } else {
                            notificationManager.error(`Failed to delete project: ${result.error}`);
                        }
                    } catch (error) {
                        notificationManager.error(`Error deleting project: ${error.message}`);
                    }
                }

                // ÌîÑÎ°úÏ†ùÌä∏ Ï∂îÍ∞Ä Î™®Îã¨ ÌëúÏãú

                function showAddProjectModal() {
                    addProjectModal.classList.remove("hidden");

                    projectNameInput.value = "";

                    // Îã§Ïùå ÌîÑÎ†àÏûÑÏóêÏÑú Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë

                    requestAnimationFrame(() => {
                        addProjectModal.classList.add("show");
                    });

                    projectNameInput.focus();
                }

                // ÌîÑÎ°úÏ†ùÌä∏ Ï∂îÍ∞Ä Î™®Îã¨ Ïà®Í∏∞Í∏∞

                function hideAddProjectModal() {
                    addProjectModal.classList.remove("show");

                    addProjectModal.classList.add("closing");

                    // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å ÌõÑ Î™®Îã¨ ÏôÑÏ†ÑÌûà Ïà®Í∏∞Í∏∞

                    setTimeout(() => {
                        addProjectModal.classList.add("hidden");

                        addProjectModal.classList.remove("closing");
                    }, 250);
                }

                // ÌîÑÎ°úÏ†ùÌä∏ Ï∂îÍ∞Ä

                async function addProject() {
                    const projectName = projectNameInput.value.trim();

                    if (!projectName) {
                        notificationManager.error("Please enter a project name");

                        return;
                    }

                    if (projects.some((p) => p.name === projectName)) {
                        notificationManager.error("A project with this name already exists");

                        return;
                    }

                    try {
                        const result = await window.localkeys.projects.create(projectName);

                        if (result.success) {
                            hideAddProjectModal();

                            await loadProjects();

                            notificationManager.success(`Project "${projectName}" created successfully`);
                        } else {
                            notificationManager.error(`Failed to create project: ${result.error}`);
                        }
                    } catch (error) {
                        notificationManager.error(`Error creating project: ${error.message}`);
                    }
                }

                // Í≤ÄÏÉâ

                function searchProjects() {
                    const query = searchInput.value.toLowerCase().trim();

                    if (!query) {
                        filteredProjects = projects;
                    } else {
                        filteredProjects = projects.filter((project) => project.name.toLowerCase().includes(query));
                    }

                    renderProjects();
                }

                function formatDate(dateString) {
                    const date = new Date(dateString);

                    const now = new Date();

                    const diffMs = now - date;

                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                    if (diffDays === 0) {
                        return "today";
                    } else if (diffDays === 1) {
                        return "yesterday";
                    } else if (diffDays < 7) {
                        return `${diffDays} days ago`;
                    } else if (diffDays < 30) {
                        return `${Math.floor(diffDays / 7)} weeks ago`;
                    } else {
                        return date.toLocaleDateString();
                    }
                }

                // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà

                searchInput.addEventListener("input", searchProjects);

                addProjectBtn.addEventListener("click", showAddProjectModal);

                settingsDropdownBtn.addEventListener("click", () => toggleDropdown("settings"));

                logsBtn.addEventListener("click", function () {
                    window.location.href = "logs.html";
                });

                lockBtn.addEventListener("click", async function () {
                    try {
                        await window.localkeys.vault.lock();
                    } catch (error) {
                        notificationManager.error(`Error locking vault: ${error.message}`);
                    }
                });

                cancelAddProject.addEventListener("click", hideAddProjectModal);

                confirmAddProject.addEventListener("click", addProject);

                projectNameInput.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        addProject();
                    }
                });

                // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Í∞êÏßÄÎ•º ÏúÑÌïú Î≥ÄÏàò

                let mouseDownTarget = null;

                // ÎßàÏö∞Ïä§ Îã§Ïö¥ Ïù¥Î≤§Ìä∏ Ï∂îÏ†Å

                document.addEventListener("mousedown", function (e) {
                    mouseDownTarget = e.target;
                });

                addProjectModal.addEventListener("click", function (e) {
                    // ÌÅ¥Î¶≠ ÏãúÏûëÍ≥º ÎÅù Î™®Îëê Î™®Îã¨ Ïò§Î≤ÑÎ†àÏù¥Ïù∏ Í≤ΩÏö∞ÏóêÎßå Îã´Í∏∞

                    if (mouseDownTarget === addProjectModal && e.target === addProjectModal) {
                        hideAddProjectModal();
                    }
                });

                // ÎßàÏö∞Ïä§ ÏóÖ Ïù¥Î≤§Ìä∏ Ï∂îÏ†Å - ÌÅ¥Î¶≠ Ìï¥Ï†úÎèÑ Î∞ñÏóêÏÑú Ìï¥Ïïº Ìï®

                document.addEventListener("mouseup", function (e) {
                    // ÌÅ¥Î¶≠ ÏãúÏûëÏù¥ Î™®Îã¨ Ïò§Î≤ÑÎ†àÏù¥ÏòÄÏßÄÎßå ÌÅ¥Î¶≠ Ìï¥Ï†úÍ∞Ä Î™®Îã¨ Ïô∏Î∂ÄÏù∏ Í≤ΩÏö∞ Î™®Îã¨ Îã´Í∏∞

                    if (mouseDownTarget === addProjectModal && e.target !== addProjectModal) {
                        mouseDownTarget = null; // Ï¥àÍ∏∞Ìôî

                        return;
                    }
                });

                // ÎìúÎ°≠Îã§Ïö¥ ÌÜ†Í∏Ä Ìï®Ïàò

                function toggleDropdown(id) {
                    const dropdown = document.getElementById(`dropdown-${id}`);

                    const allDropdowns = document.querySelectorAll(".dropdown-menu");

                    // Îã§Î•∏ ÎìúÎ°≠Îã§Ïö¥ Î™®Îëê Îã´Í∏∞

                    allDropdowns.forEach((d) => {
                        if (d !== dropdown) {
                            d.classList.add("hidden");
                        }
                    });

                    // ÌòÑÏû¨ ÎìúÎ°≠Îã§Ïö¥ ÌÜ†Í∏Ä

                    dropdown.classList.toggle("hidden");
                }

                // Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞

                document.addEventListener("click", function (e) {
                    if (!e.target.closest(".dropdown")) {
                        const allDropdowns = document.querySelectorAll(".dropdown-menu");

                        allDropdowns.forEach((d) => d.classList.add("hidden"));
                    }
                });

                // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÏÑ§Ï†ï (10Ï¥àÎßàÎã§)

                const autoRefreshInterval = setInterval(async () => {
                    if (document.visibilityState === "visible") {
                        await loadProjects();
                    }
                }, 10000);

                // ÌéòÏù¥ÏßÄÍ∞Ä Î≥¥Ïù¥ÏßÄ ÏïäÏùÑ ÎïåÎäî ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ï§ëÏßÄ

                document.addEventListener("visibilitychange", () => {
                    if (document.visibilityState === "hidden") {
                        clearInterval(autoRefreshInterval);
                    }
                });

                // CLI Î≤ÑÌäº ÏÉÅÌÉú Í¥ÄÎ¶¨

                const setCliButtonState = (text, disabled, opacity, onclick) => {
                    installCliBtn.textContent = text;

                    installCliBtn.disabled = disabled;

                    installCliBtn.style.opacity = opacity;

                    installCliBtn.onclick = onclick;
                };

                // CLI ÏûëÏóÖ Ï≤òÎ¶¨ (ÏÑ§Ïπò/Ï†úÍ±∞)

                async function handleCliAction(action) {
                    try {
                        const isInstalling = action === "install";

                        const loadingText = isInstalling ? "Installing..." : "Uninstalling...";

                        const apiMethod = isInstalling ? window.localkeys.cli.install : window.localkeys.cli.uninstall;

                        const successPrefix = isInstalling ? "installation" : "uninstallation";

                        setCliButtonState(loadingText, true, "0.6", null);

                        const result = await apiMethod();

                        if (result.success) {
                            notificationManager.success(result.message);

                            await checkCliStatus();
                        } else {
                            notificationManager.error(result.error);

                            setCliButtonState(isInstalling ? "Install CLI" : "Uninstall CLI", false, "1", isInstalling ? installCli : uninstallCli);
                        }
                    } catch (error) {
                        const actionName = action === "install" ? "installation" : "uninstallation";

                        notificationManager.error(`CLI ${actionName} failed: ${error.message}`);

                        setCliButtonState(action === "install" ? "Install CLI" : "Uninstall CLI", false, "1", action === "install" ? installCli : uninstallCli);
                    }
                }

                // CLI ÏÑ§Ïπò ÏÉÅÌÉú ÌôïÏù∏

                async function checkCliStatus() {
                    try {
                        const result = await window.localkeys.cli.check();

                        if (result.installed) {
                            setCliButtonState("Uninstall CLI", false, "1", () => handleCliAction("uninstall"));
                        } else {
                            setCliButtonState("Install CLI", false, "1", () => handleCliAction("install"));
                        }
                    } catch (error) {
                        setCliButtonState("Install CLI", false, "1", () => handleCliAction("install"));
                    }
                }

                // CLI ÏÑ§Ïπò Ìï®Ïàò

                const installCli = () => handleCliAction("install");

                // CLI Ï†úÍ±∞ Ìï®Ïàò

                const uninstallCli = () => {
                    if (confirm("Are you sure you want to uninstall the LocalKeys CLI?")) {
                        handleCliAction("uninstall");
                    }
                };

                // Ï¥àÍ∏∞ Î°úÎìú

                loadProjects();

                checkCliStatus();
            });
        </script>
    </body>
</html>
