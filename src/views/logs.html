<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LocalKeys - Logs</title>
        <link rel="stylesheet" href="../styles/common.css" />
        <style>
            .logs-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                padding-bottom: 15px;
                border-bottom: 1px solid var(--border);
            }

            .logs-title {
                font-size: 28px;
                font-weight: 600;
                color: var(--text-primary);
            }

            .header-actions {
                display: flex;
                gap: 10px;
            }

            .filters {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            .filter-group {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .filter-group label {
                font-size: 14px;
                color: var(--text-secondary);
            }

            .filter-group select {
                padding: 8px 12px;
                background-color: var(--bg-secondary);
                border: 1px solid var(--border);
                color: var(--text-primary);
                font-size: 14px;
            }

            .filter-group select:focus {
                outline: none;
                border-color: var(--accent);
            }

            .search-bar {
                position: relative;
                flex: 1;
                max-width: 300px;
            }

            .search-input {
                width: 100%;
                padding: 8px 35px 8px 12px;
                background-color: var(--bg-secondary);
                border: 1px solid var(--border);
                color: var(--text-primary);
                font-size: 14px;
            }

            .search-input:focus {
                outline: none;
                border-color: var(--accent);
            }

            .search-icon {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: var(--text-secondary);
                font-size: 14px;
            }

            .logs-container {
                background-color: var(--bg-secondary);
                border: 1px solid var(--border);
                overflow: hidden;
            }

            .log-item {
                padding: 15px 20px;
                border-bottom: 1px solid var(--border);
                transition: background-color 0.2s;
            }

            .log-item:hover {
                background-color: var(--bg-tertiary);
            }

            .log-item:last-child {
                border-bottom: none;
            }

            .log-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }

            .log-timestamp {
                font-size: 12px;
                color: var(--text-secondary);
                font-family: "Courier New", monospace;
            }

            .log-type {
                padding: 2px 8px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
            }

            .log-type.info {
                background-color: rgba(74, 158, 255, 0.2);
                color: var(--accent);
            }

            .log-type.access {
                background-color: rgba(76, 175, 80, 0.2);
                color: var(--success);
            }

            .log-type.warning {
                background-color: rgba(255, 152, 0, 0.2);
                color: var(--warning);
            }

            .log-type.error {
                background-color: rgba(244, 67, 54, 0.2);
                color: var(--error);
            }

            .log-message {
                font-size: 14px;
                color: var(--text-primary);
                line-height: 1.4;
                word-break: break-word;
            }

            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: var(--text-secondary);
            }

            .empty-state-icon {
                font-size: 64px;
                margin-bottom: 20px;
                opacity: 0.5;
            }

            .empty-state-title {
                font-size: 20px;
                font-weight: 600;
                margin-bottom: 10px;
                color: var(--text-primary);
            }

            .empty-state-description {
                margin-bottom: 30px;
                max-width: 400px;
                margin-left: auto;
                margin-right: auto;
            }

            .stats-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .stat-card {
                background-color: var(--bg-secondary);
                padding: 20px;
                border: 1px solid var(--border);
                text-align: center;
            }

            .stat-value {
                font-size: 32px;
                font-weight: 600;
                color: var(--accent);
                margin-bottom: 5px;
            }

            .stat-label {
                font-size: 14px;
                color: var(--text-secondary);
            }

            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 10px;
                margin-top: 20px;
            }

            .pagination button {
                padding: 8px 12px;
                background-color: var(--bg-secondary);
                border: 1px solid var(--border);
                color: var(--text-primary);
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .pagination button:hover:not(:disabled) {
                background-color: var(--bg-tertiary);
            }

            .pagination button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .pagination .current-page {
                padding: 8px 12px;
                background-color: var(--accent);
                color: white;
                font-weight: 600;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="logs-header">
                <h1 class="logs-title">Access Logs</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" id="refresh-btn">Refresh</button>
                    <button class="btn btn-secondary" id="back-btn">Back to Dashboard</button>
                    <button class="btn btn-danger" id="quit-btn">Quit</button>
                </div>
            </div>

            <!-- ÌÜµÍ≥Ñ Ïπ¥Îìú -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="total-logs">0</div>
                    <div class="stat-label">Total Logs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="access-logs">0</div>
                    <div class="stat-label">Access Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="security-logs">0</div>
                    <div class="stat-label">Security Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="error-logs">0</div>
                    <div class="stat-label">Errors</div>
                </div>
            </div>

            <!-- ÌïÑÌÑ∞ -->
            <div class="filters">
                <div class="filter-group">
                    <label for="type-filter">Type:</label>
                    <select id="type-filter">
                        <option value="">All Types</option>
                        <option value="info">Info</option>
                        <option value="access">Access</option>
                        <option value="warning">Warning</option>
                        <option value="error">Error</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="limit-filter">Limit:</label>
                    <select id="limit-filter">
                        <option value="50">50 entries</option>
                        <option value="100">100 entries</option>
                        <option value="200">200 entries</option>
                        <option value="500">500 entries</option>
                    </select>
                </div>

                <div class="search-bar">
                    <input type="text" class="search-input" id="search-input" placeholder="Search logs..." />
                    <span class="search-icon">üîç</span>
                </div>
            </div>

            <!-- Î°úÍ∑∏ Î™©Î°ù -->
            <div class="logs-container" id="logs-container">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò -->
            <div class="pagination" id="pagination">
                <!-- JavaScriptÎ°ú ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± -->
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const logsContainer = document.getElementById("logs-container");
                const pagination = document.getElementById("pagination");
                const typeFilter = document.getElementById("type-filter");
                const limitFilter = document.getElementById("limit-filter");
                const searchInput = document.getElementById("search-input");
                const refreshBtn = document.getElementById("refresh-btn");
                const backBtn = document.getElementById("back-btn");
                const quitBtn = document.getElementById("quit-btn");

                // ÌÜµÍ≥Ñ ÏöîÏÜå
                const totalLogsEl = document.getElementById("total-logs");
                const accessLogsEl = document.getElementById("access-logs");
                const securityLogsEl = document.getElementById("security-logs");
                const errorLogsEl = document.getElementById("error-logs");

                let allLogs = [];
                let filteredLogs = [];
                let currentPage = 1;
                const logsPerPage = 50;

                // Î°úÍ∑∏ Î°úÎìú
                async function loadLogs() {
                    try {
                        const result = await window.localkeys.logs.get();

                        if (result.success) {
                            allLogs = result.data.reverse(); // ÏµúÏã† Î°úÍ∑∏Î∂ÄÌÑ∞ ÌëúÏãú
                            applyFilters();
                            updateStats();
                        } else {
                            showError("Failed to load logs");
                        }
                    } catch (error) {
                        showError(`Error loading logs: ${error.message}`);
                    }
                }

                // ÌïÑÌÑ∞ Ï†ÅÏö©
                function applyFilters() {
                    const typeFilterValue = typeFilter.value;
                    const searchQuery = searchInput.value.toLowerCase().trim();
                    const limitValue = parseInt(limitFilter.value);

                    // ÌÉÄÏûÖ ÌïÑÌÑ∞ÎßÅ
                    filteredLogs = allLogs.filter((log) => {
                        if (typeFilterValue && log.type !== typeFilterValue) {
                            return false;
                        }

                        // Í≤ÄÏÉâ ÌïÑÌÑ∞ÎßÅ
                        if (searchQuery && !log.message.toLowerCase().includes(searchQuery)) {
                            return false;
                        }

                        return true;
                    });

                    // Í∞úÏàò Ï†úÌïú
                    if (limitValue && limitValue > 0) {
                        filteredLogs = filteredLogs.slice(0, limitValue);
                    }

                    currentPage = 1;
                    renderLogs();
                    renderPagination();
                }

                // Î°úÍ∑∏ Î†åÎçîÎßÅ
                function renderLogs() {
                    if (filteredLogs.length === 0) {
                        logsContainer.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìã</div>
              <div class="empty-state-title">No logs found</div>
              <div class="empty-state-description">
                ${allLogs.length === 0 ? "No logs have been recorded yet." : "No logs match your filter criteria."}
              </div>
            </div>
          `;
                        return;
                    }

                    const startIndex = (currentPage - 1) * logsPerPage;
                    const endIndex = startIndex + logsPerPage;
                    const pageLogs = filteredLogs.slice(startIndex, endIndex);

                    const logsHTML = pageLogs
                        .map(
                            (log) => `
          <div class="log-item">
            <div class="log-header">
              <div class="log-timestamp">${formatTimestamp(log.timestamp)}</div>
              <div class="log-type ${log.type}">${log.type}</div>
            </div>
            <div class="log-message">${escapeHtml(log.message)}</div>
          </div>
        `
                        )
                        .join("");

                    logsContainer.innerHTML = logsHTML;
                }

                // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Î†åÎçîÎßÅ
                function renderPagination() {
                    const totalPages = Math.ceil(filteredLogs.length / logsPerPage);

                    if (totalPages <= 1) {
                        pagination.innerHTML = "";
                        return;
                    }

                    let paginationHTML = "";

                    // Ïù¥Ï†Ñ Î≤ÑÌäº
                    paginationHTML += `
          <button ${currentPage === 1 ? "disabled" : ""} onclick="changePage(${currentPage - 1})">
            Previous
          </button>
        `;

                    // ÌéòÏù¥ÏßÄ Î≤àÌò∏
                    const maxVisiblePages = 5;
                    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

                    if (endPage - startPage < maxVisiblePages - 1) {
                        startPage = Math.max(1, endPage - maxVisiblePages + 1);
                    }

                    for (let i = startPage; i <= endPage; i++) {
                        if (i === currentPage) {
                            paginationHTML += `<div class="current-page">${i}</div>`;
                        } else {
                            paginationHTML += `<button onclick="changePage(${i})">${i}</button>`;
                        }
                    }

                    // Îã§Ïùå Î≤ÑÌäº
                    paginationHTML += `
          <button ${currentPage === totalPages ? "disabled" : ""} onclick="changePage(${currentPage + 1})">
            Next
          </button>
        `;

                    pagination.innerHTML = paginationHTML;
                }

                // ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω
                function changePage(page) {
                    currentPage = page;
                    renderLogs();
                    renderPagination();

                    // Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏúÑÎ°ú
                    logsContainer.scrollTop = 0;
                }

                // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                function updateStats() {
                    totalLogsEl.textContent = allLogs.length;
                    accessLogsEl.textContent = allLogs.filter((log) => log.type === "access").length;
                    securityLogsEl.textContent = allLogs.filter((log) => log.message.includes("SECURITY")).length;
                    errorLogsEl.textContent = allLogs.filter((log) => log.type === "error").length;
                }

                // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ìè¨Îß∑
                function formatTimestamp(timestamp) {
                    const date = new Date(timestamp);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMinutes = Math.floor(diffMs / (1000 * 60));
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                    if (diffMinutes < 1) {
                        return "Just now";
                    } else if (diffMinutes < 60) {
                        return `${diffMinutes} minute${diffMinutes > 1 ? "s" : ""} ago`;
                    } else if (diffHours < 24) {
                        return `${diffHours} hour${diffHours > 1 ? "s" : ""} ago`;
                    } else if (diffDays < 7) {
                        return `${diffDays} day${diffDays > 1 ? "s" : ""} ago`;
                    } else {
                        return date.toLocaleString();
                    }
                }

                // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
                function escapeHtml(text) {
                    const div = document.createElement("div");
                    div.textContent = text;
                    return div.innerHTML;
                }

                function showError(message) {
                    showMessage(message, "error");
                }

                function showMessage(message, type) {
                    const messageEl = document.createElement("div");
                    messageEl.className = `message message-${type}`;
                    messageEl.textContent = message;
                    messageEl.style.position = "fixed";
                    messageEl.style.top = "20px";
                    messageEl.style.right = "20px";
                    messageEl.style.zIndex = "1000";
                    messageEl.style.maxWidth = "400px";

                    document.body.appendChild(messageEl);

                    setTimeout(() => {
                        if (document.body.contains(messageEl)) {
                            document.body.removeChild(messageEl);
                        }
                    }, 3000);
                }

                // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
                typeFilter.addEventListener("change", applyFilters);
                limitFilter.addEventListener("change", applyFilters);
                searchInput.addEventListener("input", applyFilters);
                refreshBtn.addEventListener("click", loadLogs);

                backBtn.addEventListener("click", function () {
                    window.location.href = "dashboard.html";
                });

                quitBtn.addEventListener("click", async function () {
                    if (confirm("Are you sure you want to quit LocalKeys?")) {
                        try {
                            await window.localkeys.app.quit();
                        } catch (error) {
                            showError(`Error quitting app: ${error.message}`);
                        }
                    }
                });

                // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù (HTML onclickÏóêÏÑú ÏÇ¨Ïö©)
                window.changePage = changePage;

                // Ï¥àÍ∏∞ Î°úÎìú
                loadLogs();
            });
        </script>
    </body>
</html>
